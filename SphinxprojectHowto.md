# Sphinx Project How-To #

  * [Sphinx官网](http://sphinx.pocoo.org/)
  * [Sphinx官网文档](http://sphinx.pocoo.org/contents.html)

## 安装及使用 ##
1. 根据[这里](http://wiki.woodpecker.org.cn/moin/DocumentUsageSphinx)安装及新建一个空白项目. 其中, 创建过程中有几个步骤:
```
$ sphinx-quickstart 
...

Please indicate if you want to use one of the following Sphinx extensions:
> autodoc: automatically insert docstrings from modules (y/N) [n]: y  # 是否自动插入模块的docstrings
> doctest: automatically test code snippets in doctest blocks (y/N) [n]: y # 是否自动测试代码摘要
> intersphinx: link between Sphinx documentation of different projects (y/N) [n]: y # 是否允许不同项目的Sphinx文档之间相互链接. 
## 这3项选默认也可, 但这里尝试全为y, 因为可能以后会有用到.

If you are under Unix, a Makefile can be generated for you so that you
only have to run e.g. `make html' instead of invoking sphinx-build
directly.
> Create Makefile? (Y/n) [y]: ## 创建makefile

Finished: An initial directory structure has been created.
```

2. 创建完之后, 组织目录结构:
```
test
|-- src
|    |-- index.rst 顶层目录
|    |-- introduce.rst 相关介绍
|    |-- about.rst 关于
|    |-- bugs.rst  其他...
|    |-- Makefile  自动生成的, 可直接使用make html or make latex生成, 所生成的html和latex文档在.build/html和latex下
|    |-- conf.py  当前为默认, 也可修改相关选项
|    |-- documents Documents二级目录
|    |      |-- index.rst 二级目录首页
|    |      \-- *.rst: 所有PyMOTW文档
|    |-- .build 自动生成的构建目录
|    |-- .static 自定义静态文件
|    \-- .templates 自定义模板
\-- output 输出结果目录, shpinx-build -b html src output 指定的输出目录
```

其中, 写顶层index.rst时, 也将当前目录下要编译的rst文件列出, 同时也要加入二级目录的index.rst,如下:
```
==========================
 欢迎查阅 PyMOTW 中文版!
==========================

.. toctree::
    :maxdepth: 2
    
    introduce.rst
    documents/index.rst
    
```
这样得到的效果如下图
![http://pymotwcn.googlecode.com/files/test1.png](http://pymotwcn.googlecode.com/files/test1.png)

顶层index.rst中列出的rst被sphinx看成是一个chapter(章), 这在之后的tex文件中有体现. 下一层index.tst中的则作为对应chapter的section(节).

另外一种写法是直接包含二级目录中的rst, 这样就是把所有模块都作为一个chapter. 如:
```
==========================
 欢迎查阅 PyMOTW 中文版!
==========================

.. toctree::
    :maxdepth: 2
    
    introduce.rst
    documents/configparser.rst
    documents/queue.rst
    documents/*.rst
    
```
![http://pymotwcn.googlecode.com/files/test2.png](http://pymotwcn.googlecode.com/files/test2.png)

可以看到是首页上直接显示了document中的内容, 没有经过document下的index.rst, 这种方式对于较少的文档, 显示比较紧凑. 虽然上一种方式层次比较好看.

二级index.rst一般只需将当前目录下的其他rst加入就好,例如:
```
==============
 所有文档
==============

.. toctree::

    configparser.rst
    queue.rst
    *.rst
```

3. 接下来, 使用命令`sphinx-build -b html src output`或`make html`生成html, `sphinx-build -b latex src output`或`make latex`生成latex源文件. html文档一般情况下, 没什么问题. 如果中间rst文件有问题, 会有提示错误, 只需作相应修改就好.

4. 另外, 由于sphinx生成的html页面上默认有很多英文字链接. 所以做如下修改:
```
1) 将sphinx安装目录下(默认为/usr/lib/python2.5/site-packages/Sphinx-0.5.1-py2.5.egg/sphinx)的templates拷贝到自己工程的src/.templates, 并且把里面html文档中有_('some title')的翻译成中文.
2) 将sphinx安装目录下(默认为/usr/lib/python2.5/site-packages/Sphinx-0.5.1-py2.5.egg/sphinx)的static拷贝到.static, 样式可以自定义, 这里也可以把sphinx官网文档的样式拷贝过来, 生成的html很类似她.
3) src/index.rst及相关rst文件中, 修改成中文说明.

到此大致上可以完成汉化. 只是还剩页面顶端的导航条和首页下方的索引表的特殊模块默认名字还是英文,因为这个是在源代码中涉及的, 所以对sphinx源码做了些修改:
4) sphinx/builder.py中
line428~430修改为
        rellinks = []
        if self.config.html_use_index:
            rellinks.append(('genindex', _(u'一般索引'), 'I', _(u'索引')))#General Index index
        if self.config.html_use_modindex and self.env.modules:
            rellinks.append(('modindex', _(u'全局模块索引'), 'M', _(u'模块')))#Global Module Index modules
line468修改为
                rellinks.append((related[2], next['title'], 'N', _(u'后一篇')))
line475修改为
                rellinks.append((related[1], prev['title'], 'P', _(u'前一篇')))

sphinx/environment.py中line291~293修改为
        self.labels['genindex'] = ('genindex', '', _(u'索引'))# Index
        self.labels['modindex'] = ('modindex', '', _(u'模块索引'))# Module Index
        self.labels['search']   = ('search', '', _(u'搜索页面'))# Search Page
5) conf.py中修改项目名称为中文, 其中想自定义html_title为<project> v<release> 文档, 直接将html_title = u"<project> v<release> documentation"修改中文无法在页面上正确显示, 所以修改sphinx/config.py中line54为
        html_title = (lambda self: u'%s v%s 文档' %  (self.project, self.release), False),
```
ok, 到这, 生成的html文档已经很漂亮了

5. Tex生成PDF文件.
  * 编译生成tex中会遇到ascii decode的编码问题, 这主要是conf.py中出现中文, 可以做下修改:
```
#!python
# /usr/lib/python2.5/site-packages/Sphinx-0.5.1-py2.5.egg/sphinx/latexwriter.py
import sys
reload(sys)
sys.setdefaultencoding('utf8')
```
  * 有了tex源文件, 直接将tex编译成pdf就好. 具体可参考[Latex笔记](http://docs.google.com/View?revision=_latest&docid=df7gztdm_700cjjr9qcm&hl=zh_CN), 不过比较杂乱. 但大致步骤如下:
```
1) 安装tex/latex, 推荐直接使用texlive2007.iso安装.
2) 中文支持, UTF8和GBK两种编码, 对于sphinx生成的tex源文件默认是utf8, 转gbk不行, 所以推荐直接用前者.
3) 书签中文显示问题.
4) xelatex xx.tex 生成PDF.

最终我们使用的tex源文件:
% Generated by Sphinx.  以下是自动生成的
\documentclass[a4paper,10pt,english]{manual}
\usepackage[utf8]{inputenc}   % 其中package inputenc还需要两个文件ttfucs.sty和utf8ttf.def, 把他们放到同目录下即可.
\usepackage[T1]{fontenc}
\usepackage{babel}
\usepackage{times}
\usepackage[Bjarne]{fncychap}
\usepackage{sphinx}
% 以下是新加入的
\usepackage{hyperref}  主要是xelatex的相关包
\usepackage{fontspec}
\usepackage{xunicode}
\usepackage{xltxtra}
\XeTeXlinebreaklocale "zh"
\XeTeXlinebreakskip = 0pt plus 1pt

%使用系统字体, 支持中文的
\setsansfont{Vera Sans YuanTi Mono}
\setromanfont{Vera Sans YuanTi Mono}

\title{PyMOTW 文档}
\date{January 03, 2009}
\release{1.0}
\author{作者: \\译者:  }}
\newcommand{\sphinxlogo}{}
%\renewcommand{\releasename}{Release}
\renewcommand{\releasename}{版本}
... 余下的部分
\begin{document}

\maketitle
\tableofcontents
\resetcurrentobjects

\chapter{PyMOTW: ConfigParser}
\begin{itemize}
\item {} 
模块： ConfigParser
...
```
5. 完毕,,,